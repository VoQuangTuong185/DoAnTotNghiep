<div class="block">
    <p-accordion>
        <p-accordionTab header="Quản lý tài khoản" class="center" [selected]="true">
            <span class="flex justify-content-center  filter-user">
                <p-selectButton [options]="roles" [(ngModel)]="selectedRole" [multiple]="false" optionLabel="name" optionValue="value" (onOptionClick)="changeRoleUserDisplay($event)"></p-selectButton>
            </span>
            <div class="search-box">
                <span>
                    <input pTooltip="Global Seach" tooltipPosition="bottom" type="text" pInputText placeholder="Tìm kiếm" 
                    matInput (input)="tdt.filterGlobal($any($event.target).value, 'contains')"/>
                </span>
            </div>          
            <div class="displayUsers">
                <p-table #tdt [value]="dataUsers" [columns]="usersDataCols" class="table-content"[rows]="rows"
                    [virtualRowHeight]="340" [paginator]="true" [showCurrentPageReport]="true" [(first)]="first" [loading]="loading"
                    [resizableColumns]="true" [reorderableColumns]="true" 
                    [globalFilterFields]="['name','loginName','email','telNum', 'address','discount']"
                    [rowsPerPageOptions]="[5, 10, 20]"
                    currentPageReportTemplate="Hiển thị {first} - {last} trong tổng số {totalRecords} dữ liệu">
                    <ng-template pTemplate="header" let-columns>
                        <tr>
                            <th pReorderableColumn pResizableColumn *ngFor="let col of columns" [style.width]="col.width + '%'">
                                <span>{{ col.header }}</span>
                            </th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-columns="columns" let-rowIndex="rowIndex" let-rowData>
                        <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex">
                            <td *ngFor="let col of columns" >
                            <span [ngSwitch]="col.type">
                                <span *ngSwitchCase="'number'">{{ rowIndex + 1 }}</span>
                                <span *ngSwitchCase="'percent'">{{ rowData[col.field] >=5 ? rowData[col.field] : 0 }}%</span>
                                <span *ngSwitchCase="'button'" class="button"> 
                                    <td>
                                        <button pButton icon="pi pi-pencil" pTooltip="Chỉnh sửa" tooltipPosition="bottom" class="p-button-rounded p-button-success mr-2" (click)="editUser(rowData)"></button>
                                        <button *ngIf="rowData.isActive" pButton icon="pi pi-lock" pTooltip="Khoá" tooltipPosition="bottom" class="p-button-rounded p-button-danger mr-2" (click)="activeOrInActiveUser(rowData)"></button>
                                        <button *ngIf="!rowData.isActive" pButton icon="pi pi-lock-open" pTooltip="Mở khoá" tooltipPosition="bottom" class="p-button-rounded p-button-secondary mr-2" (click)="activeOrInActiveUser(rowData)"></button>
                                        <button pButton icon="pi pi-user-plus" tooltipPosition="bottom" [ngClass]="handleButtonSetManager(rowData) ? 'p-button-rounded p-button-info mr-2' : 'p-button-rounded p-button-secondary mr-2'"  
                                        (click)="setManagerPermisson(rowData)" [pTooltip]="handleTooltipSetManager(rowData)"></button>
                                    </td> 
                                </span>
                                <span *ngSwitchCase="'boolean'" pTooltip="{{ rowData[col.field] == true ? 'Hoạt động' : 'Khoá' }}" tooltipPosition="bottom">{{ rowData[col.field] == true ? 'Hoạt động' : 'Khoá' }}</span>
                                <span *ngSwitchDefault pTooltip="{{rowData[col.field]}}" tooltipPosition="bottom" >{{ rowData[col.field] }}</span> 
                            </span>                   
                            </td>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="13">No data found.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
         </p-accordionTab>
    </p-accordion>
    <form [formGroup]="editUserForm" (ngSubmit)="confirmEditUser()">
        <p-dialog [(visible)]="displayEditUserPopup" [style]="{width: '450px'}" header="Thông tin tài khoản chi tiết" [modal]="true" styleClass="p-fluid">
                <ng-template pTemplate="content">
                    <mat-form-field appearance="outline">
                        <mat-label>Họ và Tên</mat-label>
                        <input matInput formControlName = "Name" name = "Name" required="">   
                        <mat-error *ngIf="editUserForm.get('Name')?.hasError('required')">
                            Hãy nhập Họ và Tên!
                        </mat-error>         
                        <mat-error *ngIf="editUserForm.get('Name')?.hasError('maxlength')">
                            Số lượng kí tự tối đa là 50!
                          </mat-error>                     
                    </mat-form-field>
                    <mat-form-field appearance="outline">     
                        <mat-label>Tài Khoản</mat-label>
                        <input matInput formControlName = "LoginName" name = "LoginName" required=""> 
                        <mat-error *ngIf="editUserForm.get('LoginName')?.hasError('required')">
                            Hãy nhập Tài khoản!
                        </mat-error>
                        <mat-error *ngIf="editUserForm.get('LoginName')?.hasError('maxlength')">
                            Số lượng kí tự tối đa là 50!
                          </mat-error>         
                    </mat-form-field>      
                    <mat-form-field appearance="outline" pTooltip="Bạn không thể chỉnh sửa địa chỉ email của người dùng" tooltipPosition="bottom"> 
                        <mat-label>Địa chỉ email</mat-label>   
                        <input matInput formControlName = "Email" name = "Email" required=""> 
                        <mat-error *ngIf="editUserForm.get('Email')?.hasError('email')">
                            Địa chỉ email bạn nhập không hợp lệ!
                        </mat-error>
                        <mat-error *ngIf="editUserForm.get('Email')?.hasError('maxlength')">
                          Số lượng kí tự tối đa là 255!
                        </mat-error>  
                    </mat-form-field>        
                    <mat-form-field appearance="outline"> 
                        <mat-label>Số điện thoại</mat-label>     
                        <input matInput formControlName = "TelNum" name = "TelNum" required="">
                        <mat-error *ngIf="editUserForm.get('TelNum')?.hasError('required')">
                            Hãy nhập số điện thoại
                        </mat-error>
                        <mat-error *ngIf="editUserForm.get('TelNum')?.hasError('minlength')">
                            Định dạng số điện thoại chưa chính xác!
                        </mat-error>
                        <mat-error *ngIf="editUserForm.get('TelNum')?.hasError('maxlength')">
                            Định dạng số điện thoại chưa chính xác!
                        </mat-error>  
                    </mat-form-field>     
                </ng-template>
                <ng-template pTemplate="footer">
                    <button pButton pRipple label="Huỷ" icon="pi pi-times" class="p-button-secondary" type="button" (click)="hideEditUserPopup()"></button>
                    <button pButton pRipple label="Lưu" icon="pi pi-check" class="p-button-success"></button>
                </ng-template>
        </p-dialog>
    </form>
</div>
